{% extends 'tickets/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>{{ ticket.title }}</h4>
                <span class="badge bg-{% if ticket.status == 'open' %}primary{% elif ticket.status == 'in_progress' %}warning{% elif ticket.status == 'resolved' %}success{% else %}secondary{% endif %}">
                    {{ ticket.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <p><strong>Description:</strong></p>
                <p>{{ ticket.description }}</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Priority:</strong> 
                            <span class="badge bg-{% if ticket.priority == 'low' %}info{% elif ticket.priority == 'medium' %}primary{% elif ticket.priority == 'high' %}warning{% else %}danger{% endif %}">
                                {{ ticket.get_priority_display }}
                            </span>
                        </p>
                        <p><strong>Created by:</strong> {{ ticket.created_by.username }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Assigned to:</strong> {{ ticket.assigned_to.username|default:"Unassigned" }}</p>
                        <p><strong>Created:</strong> {{ ticket.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Comments</h5>
            </div>
            <div class="card-body">
                {% for comment in ticket.comments.all %}
                    <div class="mb-3 p-3 border rounded {% if comment.is_internal %}bg-light{% endif %}">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.author.username }}</strong>
                            <small>{{ comment.created_at|date:"M d, Y H:i" }}</small>
                        </div>
                        <p class="mb-0">{{ comment.content }}</p>
                        {% if comment.is_internal %}
                            <span class="badge bg-secondary">Internal Note</span>
                        {% endif %}
                    </div>
                {% empty %}
                    <p>No comments yet.</p>
                {% endfor %}
                
                <form method="post" class="mt-3">
                    {% csrf_token %}
                    {{ comment_form.as_p }}
                    <button type="submit" name="add_comment" class="btn btn-primary">Add Comment</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Assign to Me Button Card -->
        {% if user.is_staff or user.groups.all.0.name == 'IT Staff' %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>IT Actions</h5>
            </div>
            <div class="card-body">
                <a href="{% url 'assign_to_me' ticket.pk %}" class="btn btn-info w-100 mb-2">
                    <i class="bi bi-person-check"></i> Assign to Me
                </a>
                <a href="{% url 'update_ticket' ticket.pk %}" class="btn btn-warning w-100 mb-2">
                    <i class="bi bi-pencil"></i> Update Ticket
                </a>
                {% if ticket.assigned_to %}
                <div class="text-center mt-2">
                    <small>Currently assigned to: <strong>{{ ticket.assigned_to.username }}</strong></small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h5>Attachments</h5>
            </div>
            <div class="card-body">
                {% for attachment in ticket.attachments.all %}
                    <div class="mb-2">
                        <a href="{{ attachment.file.url }}" target="_blank">{{ attachment.file.name }}</a>
                        <br>
                        <small>Uploaded by {{ attachment.uploaded_by.username }} on {{ attachment.uploaded_at|date:"M d, Y" }}</small>
                    </div>
                {% empty %}
                    <p>No attachments.</p>
                {% endfor %}
                
                <form method="post" enctype="multipart/form-data" class="mt-3">
                    {% csrf_token %}
                    {{ attachment_form.as_p }}
                    <button type="submit" name="add_attachment" class="btn btn-primary">Upload Attachment</button>
                </form>
            </div>
        </div>

        {% if user.is_staff or user.groups.all.0.name == 'IT Staff' %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Danger Zone</h5>
            </div>
            <div class="card-body">
                {% if ticket.status == 'closed' %}
                <form method="post" action="{% url 'delete_ticket' ticket.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" 
                            onclick="return confirm('Are you sure you want to delete this closed ticket? This action cannot be undone.')">
                        <i class="bi bi-trash"></i> Delete Ticket
                    </button>
                </form>
                {% else %}
                <p class="text-muted">Ticket must be closed before it can be deleted.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

